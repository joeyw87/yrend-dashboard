<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì—°ë§ì •ì‚° ì „ì‚¬ ìˆ˜ì§‘í˜„í™© í†µí•© ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #fd7e14;
            --info: #17a2b8;
            --danger: #dc3545;
            --dark: #343a40;
            --border: #e9ecef;
            --purple: #6f42c1;
            --teal: #20c997;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 25px;
            color: #333;
        }

        .top-container {
            margin-bottom: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--dark);
            font-size: 1.8rem;
            margin: 0;
        }

        .upload-area {
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 15px;
        }

        .btn-file {
            background: var(--dark);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-file:hover {
            background: #23272b;
        }

        .btn-download {
            background: var(--success);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        }

        .btn-download:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }

        .btn-parser {
            background: var(--primary);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }

        .btn-parser:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        #jsonInput {
            display: none;
        }

        /* ìš”ì•½ ì¹´ë“œ ì„¹ì…˜ */
        .summary-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 4px solid transparent;
        }

        .summary-card h3 {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 800;
            margin: 10px 0;
            display: block;
        }

        .summary-card .sub-text {
            font-size: 0.8rem;
            font-weight: bold;
            color: #999;
        }

        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .chart-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-card.tall {
            height: 450px;
        }
        
        /* ìŠ¤í¬ë˜í•‘ & PDF ì„¹ì…˜ì˜ ì¹´ë“œë“¤ì€ ë™ì¼í•œ ë†’ì´ë¡œ */
        #chartSection2 .chart-card {
            height: 420px;
        }

        .chart-card h4 {
            margin: 0 0 15px 0;
            font-size: 0.95rem;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .chart-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            min-height: 0;
        }

        /* ì»¨íŠ¸ë¡¤ */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sort-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-sort,
        .btn-filter {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: 0.2s;
        }
        
        .btn-filter {
            padding: 10px 18px;
            font-size: 0.9rem;
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .filter-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 14px;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .toggle-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-slider:hover {
            background-color: #999;
        }

        .toggle-switch input:checked + .toggle-slider:hover {
            background-color: #0056b3;
        }

        .btn-sort:hover,
        .btn-filter:hover {
            background-color: #f8f9fa;
        }

        .btn-sort.active,
        .btn-filter.active {
            background-color: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        /* í…Œì´ë¸” */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            color: #555;
            padding: 15px;
            font-size: 0.85rem;
            border-bottom: 2px solid var(--border);
            text-align: left;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .group-cell {
            border-right: 1px solid var(--border);
            width: 200px;
        }

        .group-id {
            font-weight: bold;
            color: #1a1a1a;
            display: block;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .group-meta {
            font-size: 0.7rem;
            color: #999;
            margin-top: 3px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item span {
            font-size: 0.65rem;
            color: #888;
            display: block;
        }

        .stat-item b {
            font-size: 0.9rem;
            display: block;
            margin-top: 2px;
        }

        .progress-bar-container {
            background: #eee;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background: #e7f3ff;
            color: var(--primary);
        }

        .badge-success {
            background: #d4edda;
            color: var(--success);
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .wait-color {
            color: var(--warning);
        }

        .hidden {
            display: none !important;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.2s;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .company-list {
            display: grid;
            gap: 15px;
        }

        .company-item {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--success);
            transition: 0.2s;
        }

        .company-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .company-name {
            font-weight: bold;
            color: var(--dark);
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .company-id {
            font-family: 'Consolas', monospace;
            color: #666;
            font-size: 0.85rem;
        }

        .company-stats {
            margin-top: 8px;
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: #888;
        }

        .company-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .saas-section {
            margin-bottom: 25px;
        }

        .saas-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saas-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <div class="top-container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1>ğŸ“Š 2025 ì—°ë§ì •ì‚° ì§„í–‰í˜„í™© í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
                <div class="filter-toggle-container" id="filterToggleContainer" style="display: none;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="filterToggle" onchange="toggleFilter()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">ê³„ì†ê·¼ë¬´ìë§Œ</span>
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a href="./fileParser.html" class="btn-parser" target="_blank">
                    ğŸ”„ JSON ë³€í™˜
                </a>
                <a href="./data/saas_data.json" download="saas_data.json" class="btn-download">
                    ğŸ“¥ ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ
                </a>
                <div class="upload-area">
                    <span id="fileName">JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
                    <label for="jsonInput" class="btn-file">íŒŒì¼ ì„ íƒ</label>
                    <input type="file" id="jsonInput" accept=".json">
                </div>
            </div>
        </div>

        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="summary-wrapper hidden" id="summarySection">
            <div class="summary-card" style="border-top-color: var(--dark);">
                <h3>ëŒ€ìƒ ê·¸ë£¹ìˆ˜</h3>
                <p class="value" id="totalGroups">0</p>
                <span class="sub-text">Companies</span>
            </div>
            <div class="summary-card" style="border-top-color: var(--info);">
                <h3>ì´ ëŒ€ìƒ ì¸ì›</h3>
                <p class="value" id="totalEmp">0</p>
                <span class="sub-text">Total Employees</span>
            </div>
            <div class="summary-card" style="border-top-color: var(--warning);">
                <h3>ì‘ì—… ëŒ€ê¸°</h3>
                <p class="value wait-color" id="totalWait">0</p>
                <span class="sub-text" id="waitRate">0%</span>
            </div>
            <div class="summary-card" style="border-top-color: var(--success);">
                <h3>ê´€ë¦¬ì ë§ˆê°</h3>
                <p class="value" style="color:var(--success)" id="totalAdminConfirm">0</p>
                <span class="sub-text" id="adminRate">0%</span>
            </div>
            <div class="summary-card" style="border-top-color: var(--primary);">
                <h3>ì‚¬ìš©ì ë§ˆê°</h3>
                <p class="value" style="color:var(--primary)" id="totalUserConfirm">0</p>
                <span class="sub-text" id="userRate">0%</span>
            </div>
            <div class="summary-card" style="border-top-color: var(--danger);">
                <h3>ë§ˆê° ì·¨ì†Œ</h3>
                <p class="value" style="color:var(--danger)" id="totalCancel">0</p>
                <span class="sub-text" id="cancelRate">0%</span>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ 1: ì‘ì—… í˜„í™© -->
        <div class="chart-section hidden" id="chartSection1">
            <h2 class="section-title">ğŸ“ˆ ì—°ë§ì •ì‚° ì‘ì—… í˜„í™©</h2>
            <div class="chart-row">
                <div class="chart-card">
                    <h4>ì „ì²´ ì‘ì—… ìƒíƒœ ë¶„í¬</h4>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>ê³„ì†ê·¼ë¬´ì vs ì¤‘ë„í‡´ì§ì ì¸ì› ë¹„ì¤‘</h4>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>ì‘ì—… ì§„í–‰ë¥  (ê´€ë¦¬ì ë§ˆê° ê¸°ì¤€)</h4>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ 2: ìŠ¤í¬ë˜í•‘ & PDF ì œì¶œ -->
        <div class="chart-section hidden" id="chartSection2">
            <h2 class="section-title">ğŸ”„ ìŠ¤í¬ë˜í•‘ í™œìš© & PDF ì œì¶œ í˜„í™©</h2>
            <div class="chart-row">
                <div class="chart-card">
                    <h4>ìŠ¤í¬ë˜í•‘ ë°©ì‹ë³„ ì‚¬ìš© í˜„í™©</h4>
                    <div class="chart-container">
                        <canvas id="scrapChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>PDF ì œì¶œ ë°©ì‹ ë¶„í¬</h4>
                    <div class="chart-container">
                        <canvas id="pdfChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h4>í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© í˜„í™©</h4>
                    <div class="chart-container">
                        <canvas id="easyPdfChart"></canvas>
                    </div>
                    <div id="easyPdfCompanyInfo"></div>
                </div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ 3: ê·¸ë£¹ë³„ ìƒì„¸ -->
        <div class="chart-section hidden" id="chartSection3">
            <h2 class="section-title">ğŸ¢ ê·¸ë£¹ë³„ ì§„í–‰ë¥  TOP 10</h2>
            <div class="chart-row">
                <div class="chart-card" style="grid-column: 1 / -1; height: 450px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; border: none; padding: 0;">SaaSë³„ ì§„í–‰ë¥  (ê´€ë¦¬ì ë§ˆê° ê¸°ì¤€)</h4>
                        <select id="saasSelector" onchange="updateSaasChart()"
                            style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.85rem;">
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="topCompanyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls hidden" id="controls">
            <div class="sort-area">
                <button class="btn-sort" onclick="sortData('desc')">ëŒ€ìƒì ë§ì€ ìˆœ â†“</button>
                <button class="btn-sort" onclick="sortData('asc')">ëŒ€ìƒì ì ì€ ìˆœ â†‘</button>
            </div>
        </div>
    </div>

    <!-- í…Œì´ë¸” -->
    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th class="group-cell">ê·¸ë£¹ ì •ë³´</th>
                    <th>ê³„ì†ê·¼ë¬´ì (StlTp: 1)</th>
                    <th>ì¤‘ë„í‡´ì§ì (StlTp: 2)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="3" style="text-align:center; padding: 100px; color: #ccc;">
                        ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="easyPdfModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“‹ í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ëª©ë¡</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let filterActive = false;
        let charts = {};
        let saasGroups = {};

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        document.getElementById('jsonInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').innerText = file.name;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = JSON.parse(event.target.result);
                    rawData = Array.isArray(data) ? data : Object.values(data).flat();
                    
                    // YREND ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ totalSum ê³„ì‚°
                    rawData.forEach(group => {
                        const yrendData = group.ìˆ˜ì§‘ì •ë³´_parsed.filter(i => i.txformCd === 'YREND');
                        group.totalSum = yrendData.reduce((acc, curr) => acc + curr.totalCnt, 0);
                    });
                    
                    // UI í‘œì‹œ
                    document.getElementById('summarySection').classList.remove('hidden');
                    document.getElementById('chartSection1').classList.remove('hidden');
                    document.getElementById('chartSection2').classList.remove('hidden');
                    document.getElementById('chartSection3').classList.remove('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    document.getElementById('filterToggleContainer').style.display = 'flex';
                    
                    renderDashboard(rawData);
                } catch (e) {
                    alert("JSON íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            };
            reader.readAsText(file);
        });

        function renderDashboard(data) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            // ì§‘ê³„ ë³€ìˆ˜ ì´ˆê¸°í™”
            let stats = {
                groups: 0,
                totalEmp: 0,
                waitCnt: 0,
                userConfirmCnt: 0,
                adminConfirmCnt: 0,
                cancelConfirmCnt: 0,
                type1Cnt: 0,
                type2Cnt: 0,
                scrapMobileCnt: 0,
                scrapWebCnt: 0,
                pdfAdminCnt: 0,
                pdfUserCnt: 0,
                easyPdfCnt: 0,
                easyPdfCompanyCnt: 0  // í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ìˆ˜
            };
            
            saasGroups = {};

            data.forEach(group => {
                // YREND ë°ì´í„°ë§Œ í•„í„°ë§
                const yrendData = group.ìˆ˜ì§‘ì •ë³´_parsed.filter(i => i.txformCd === 'YREND');
                
                // í•„í„° ì ìš©
                const targetInfo = filterActive ? yrendData.filter(i => i.stlTp === "1") : yrendData;
                if (targetInfo.length === 0 && filterActive) return;

                stats.groups++;

                // íƒ€ì…ë³„ ì§‘ê³„ í•¨ìˆ˜
                const sumByType = (type) => {
                    const filtered = yrendData.filter(i => i.stlTp === type);
                    if (filtered.length === 0) return null;
                    return filtered.reduce((acc, curr) => ({
                        totalCnt: acc.totalCnt + curr.totalCnt,
                        waitCnt: acc.waitCnt + curr.waitCnt,
                        userConfirmCnt: acc.userConfirmCnt + curr.userConfirmCnt,
                        adminConfirmCnt: acc.adminConfirmCnt + curr.adminConfirmCnt,
                        cancelConfirmCnt: acc.cancelConfirmCnt + curr.cancelConfirmCnt,
                        scrapReqTypeMCnt: acc.scrapReqTypeMCnt + curr.scrapReqTypeMCnt,
                        scrapReqTypeWCnt: acc.scrapReqTypeWCnt + curr.scrapReqTypeWCnt,
                        pdfupload1Cnt: acc.pdfupload1Cnt + curr.pdfupload1Cnt,
                        pdfupload2Cnt: acc.pdfupload2Cnt + curr.pdfupload2Cnt,
                        easyPdfCnt: acc.easyPdfCnt + curr.easyPdfCnt
                    }), {
                        totalCnt: 0, waitCnt: 0, userConfirmCnt: 0, adminConfirmCnt: 0,
                        cancelConfirmCnt: 0, scrapReqTypeMCnt: 0, scrapReqTypeWCnt: 0,
                        pdfupload1Cnt: 0, pdfupload2Cnt: 0, easyPdfCnt: 0
                    });
                };

                const type1Combined = sumByType("1");
                const type2Combined = sumByType("2");

                // ì „ì²´ í†µê³„ ëˆ„ì  (ì‘ì—… í˜„í™©ì€ í•„í„° ì ìš©, ìŠ¤í¬ë˜í•‘/PDFëŠ” ì „ì²´ YREND ë°ì´í„°)
                targetInfo.forEach(i => {
                    stats.totalEmp += i.totalCnt;
                    stats.waitCnt += i.waitCnt;
                    stats.userConfirmCnt += i.userConfirmCnt;
                    stats.adminConfirmCnt += i.adminConfirmCnt;
                    stats.cancelConfirmCnt += i.cancelConfirmCnt;
                    
                    if (i.stlTp === "1") stats.type1Cnt += i.totalCnt;
                    if (i.stlTp === "2") stats.type2Cnt += i.totalCnt;
                });
                
                // ìŠ¤í¬ë˜í•‘, PDF, í¸ë¦¬í•œ ì—°ë§ì •ì‚°ì€ í•­ìƒ ì „ì²´ YREND ë°ì´í„° ì§‘ê³„
                let hasEasyPdf = false;
                yrendData.forEach(i => {
                    stats.scrapMobileCnt += i.scrapReqTypeMCnt || 0;
                    stats.scrapWebCnt += i.scrapReqTypeWCnt || 0;
                    stats.pdfAdminCnt += i.pdfupload1Cnt || 0;
                    stats.pdfUserCnt += i.pdfupload2Cnt || 0;
                    stats.easyPdfCnt += i.easyPdfCnt || 0;
                    
                    // í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ì¹´ìš´íŠ¸ (1ëª…ì´ë¼ë„ ì‚¬ìš©í•˜ë©´ ì¹´ìš´íŠ¸)
                    if ((i.easyPdfCnt || 0) > 0) {
                        hasEasyPdf = true;
                    }
                });
                
                if (hasEasyPdf) {
                    stats.easyPdfCompanyCnt++;
                }

                // SaaSë³„ ê·¸ë£¹í™”
                const saasName = group.ì„œë²„ëª…;
                if (!saasGroups[saasName]) saasGroups[saasName] = [];
                
                const confirm = targetInfo.reduce((a, b) => a + b.adminConfirmCnt, 0);
                const total = targetInfo.reduce((a, b) => a + b.totalCnt, 0);
                
                saasGroups[saasName].push({
                    id: group.ê·¸ë£¹ìˆœë²ˆ,
                    name: group.ì„œë²„ëª…,
                    rate: Math.round((confirm / total) * 100) || 0,
                    totalCnt: total
                });

                // í…Œì´ë¸” í–‰ ìƒì„±
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="group-cell">
                        <span class="group-id">${group.ê·¸ë£¹ìˆœë²ˆ}</span>
                        <div class="group-meta">${group.ì„œë²„ëª…}</div>
                        <div class="group-meta">ìˆ˜ì§‘ì¼: ${group.ìˆ˜ì§‘ì¼}</div>
                        <div class="group-meta" style="color:var(--dark); font-weight:bold; margin-top:4px;">
                            ${filterActive ? 'ê³„ì†ê·¼ë¬´ì: ' + (type1Combined?.totalCnt || 0) : 'ì „ì²´: ' + group.totalSum}ëª…
                        </div>
                    </td>
                    <td>${getStatHtml(type1Combined, 'var(--primary)', 'ê³„ì†ê·¼ë¬´ì')}</td>
                    <td>${filterActive ? '<div style="color:#ddd; text-align:center;">í•„í„° ì ìš©ë¨</div>' : getStatHtml(type2Combined, 'var(--success)', 'ì¤‘ë„í‡´ì§ì')}</td>
                `;
                body.appendChild(row);
            });

            // SaaS ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            updateSaasSelector();
            
            // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            updateSummary(stats);
            initCharts(stats);
        }

        function updateSummary(s) {
            document.getElementById('totalGroups').innerText = s.groups.toLocaleString();
            document.getElementById('totalEmp').innerText = s.totalEmp.toLocaleString();
            document.getElementById('totalWait').innerText = s.waitCnt.toLocaleString();
            document.getElementById('totalAdminConfirm').innerText = s.adminConfirmCnt.toLocaleString();
            document.getElementById('totalUserConfirm').innerText = s.userConfirmCnt.toLocaleString();
            document.getElementById('totalCancel').innerText = s.cancelConfirmCnt.toLocaleString();
            
            document.getElementById('waitRate').innerText = `${Math.round((s.waitCnt / s.totalEmp) * 100) || 0}%`;
            document.getElementById('adminRate').innerText = `${Math.round((s.adminConfirmCnt / s.totalEmp) * 100) || 0}%`;
            document.getElementById('userRate').innerText = `${Math.round((s.userConfirmCnt / s.totalEmp) * 100) || 0}%`;
            document.getElementById('cancelRate').innerText = `${Math.round((s.cancelConfirmCnt / s.totalEmp) * 100) || 0}%`;
        }

        function initCharts(s) {
            // 1. ì‘ì—… ìƒíƒœ ë¶„í¬
            updateChart('statusChart', 'doughnut', {
                labels: ['ì‘ì—…ëŒ€ê¸°', 'ì‚¬ìš©ìë§ˆê°', 'ê´€ë¦¬ìë§ˆê°', 'ë§ˆê°ì·¨ì†Œ'],
                datasets: [{
                    data: [s.waitCnt, s.userConfirmCnt, s.adminConfirmCnt, s.cancelConfirmCnt],
                    backgroundColor: ['#fd7e14', '#007bff', '#28a745', '#dc3545']
                }]
            }, {
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 }, padding: 10 } }
                }
            });

            // 2. ì •ê¸° vs ì¤‘ë„
            updateChart('typeChart', 'pie', {
                labels: ['ê³„ì†ê·¼ë¬´ì', 'ì¤‘ë„í‡´ì§ì'],
                datasets: [{
                    data: [s.type1Cnt, s.type2Cnt],
                    backgroundColor: ['#007bff', '#20c997']
                }]
            }, {
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 }, padding: 10 } }
                }
            });

            // 3. ì‘ì—… ì§„í–‰ë¥ 
            const progressData = [
                { label: 'ê´€ë¦¬ì ë§ˆê°', value: s.adminConfirmCnt, color: '#28a745' },
                { label: 'ì‚¬ìš©ì ë§ˆê°', value: s.userConfirmCnt, color: '#007bff' },
                { label: 'ì‘ì—… ëŒ€ê¸°', value: s.waitCnt, color: '#fd7e14' }
            ];
            updateChart('progressChart', 'bar', {
                labels: progressData.map(d => d.label),
                datasets: [{
                    label: 'ì¸ì›ìˆ˜',
                    data: progressData.map(d => d.value),
                    backgroundColor: progressData.map(d => d.color)
                }]
            }, {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { font: { size: 10 } } },
                    y: { ticks: { font: { size: 11 } } }
                }
            });

            // 4. ìŠ¤í¬ë˜í•‘ ë°©ì‹
            updateChart('scrapChart', 'doughnut', {
                labels: ['ëª¨ë°”ì¼', 'ì›¹'],
                datasets: [{
                    data: [s.scrapMobileCnt, s.scrapWebCnt],
                    backgroundColor: ['#6f42c1', '#17a2b8']
                }]
            }, {
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 }, padding: 10 } }
                }
            });

            // 5. PDF ì œì¶œ ë°©ì‹ (ì°¸ê³ : í•œ ì‚¬ëŒì´ ì—¬ëŸ¬ PDF ì œì¶œ ê°€ëŠ¥í•˜ë¯€ë¡œ í•©ê³„ê°€ ëŒ€ìƒ ì¸ì› ì´ˆê³¼ ê°€ëŠ¥)
            updateChart('pdfChart', 'pie', {
                labels: ['ê´€ë¦¬ì ì œì¶œ', 'ì‚¬ìš©ì ì œì¶œ'],
                datasets: [{
                    data: [s.pdfAdminCnt, s.pdfUserCnt],
                    backgroundColor: ['#6f42c1', '#20c997']
                }]
            }, {
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 }, padding: 10 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value.toLocaleString()}ê±´`;
                            }
                        }
                    }
                }
            });

            // 6. í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© í˜„í™© (íšŒì‚¬ ìˆ˜ëŠ” í…ìŠ¤íŠ¸, ì‚¬ìš©ì ìˆ˜ëŠ” ê·¸ë˜í”„)
            const easyPdfRate = s.totalEmp > 0 ? Math.round((s.easyPdfCnt / s.totalEmp) * 100) : 0;
            const companyRate = s.groups > 0 ? Math.round((s.easyPdfCompanyCnt / s.groups) * 100) : 0;
            const notUsing = s.totalEmp - s.easyPdfCnt;
            
            updateChart('easyPdfChart', 'doughnut', {
                labels: ['ì‚¬ìš©', 'ë¯¸ì‚¬ìš©'],
                datasets: [{
                    data: [s.easyPdfCnt, notUsing],
                    backgroundColor: ['#28a745', '#e9ecef']
                }]
            }, {
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 }, padding: 10 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percent = s.totalEmp > 0 ? Math.round((value / s.totalEmp) * 100) : 0;
                                return `${label}: ${value.toLocaleString()}ëª… (${percent}%)`;
                            }
                        }
                    }
                }
            });
            
            // í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ìˆ˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('easyPdfCompanyInfo').innerHTML = `
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; cursor: pointer; transition: 0.2s;" 
                     onmouseover="this.style.background='#e9ecef'" 
                     onmouseout="this.style.background='#f8f9fa'"
                     onclick="showEasyPdfCompanyModal()">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ì‚¬ìš© íšŒì‚¬ ìˆ˜ <span style="font-size: 0.7rem; color: #999;">â–¼ í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</span></div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${s.easyPdfCompanyCnt}</div>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">ì „ì²´ ${s.groups}ê°œ ì¤‘ ${companyRate}%</div>
                </div>
            `;

            // 7. SaaSë³„ ì§„í–‰ë¥ 
            updateSaasChart();
        }

        function updateChart(id, type, data, options = {}) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    ...options
                }
            });
        }

        function updateSaasSelector() {
            const selector = document.getElementById('saasSelector');
            const prevValue = selector.value;
            selector.innerHTML = '';

            // 'ì „ì²´' ì˜µì…˜ ì¶”ê°€
            const allOpt = document.createElement('option');
            allOpt.value = 'ALL';
            allOpt.innerText = 'ì „ì²´';
            selector.appendChild(allOpt);

            Object.keys(saasGroups).sort().forEach(saas => {
                const opt = document.createElement('option');
                opt.value = saas;
                opt.innerText = saas;
                selector.appendChild(opt);
            });

            if (prevValue && (prevValue === 'ALL' || saasGroups[prevValue])) {
                selector.value = prevValue;
            } else {
                selector.value = 'ALL';
            }
        }

        function updateSaasChart() {
            const selectedSaas = document.getElementById('saasSelector').value;
            let targetData = [];

            if (selectedSaas === "ALL") {
                // ì „ì²´ ì„ íƒ ì‹œ ëª¨ë“  SaaS ê·¸ë£¹ì˜ ë°ì´í„°ë¥¼ í•©ì¹¨
                targetData = Object.values(saasGroups).flat();
            } else {
                if (!saasGroups[selectedSaas]) return;
                targetData = saasGroups[selectedSaas];
            }

            // ì¸ì›ìˆ˜ê°€ ë§ì€ ìˆœìœ¼ë¡œ ìƒìœ„ 10ê°œ ì¶”ì¶œ
            const top10 = [...targetData]
                .sort((a, b) => b.totalCnt - a.totalCnt)
                .slice(0, 10);

            updateChart('topCompanyChart', 'bar', {
                labels: top10.map(v => `${v.name} (ID:${v.id})`),
                datasets: [{
                    label: 'ê´€ë¦¬ì ë§ˆê°ë¥ (%)',
                    data: top10.map(v => v.rate),
                    backgroundColor: '#007bff',
                    borderRadius: 4
                }]
            }, {
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const item = top10[context.dataIndex];
                                return ` ì§„í–‰ë¥ : ${item.rate}% (ëŒ€ìƒ: ${item.totalCnt}ëª…)`;
                            }
                        }
                    }
                },
                scales: {
                    x: { max: 100, ticks: { font: { size: 10 } } },
                    y: { ticks: { font: { size: 10, weight: 'bold' } } }
                }
            });
        }

        function getStatHtml(info, color, label) {
            if (!info) return '<div style="color:#ddd; text-align:center; font-size:0.85rem;">ë°ì´í„° ì—†ìŒ</div>';
            
            const rate = Math.round((info.adminConfirmCnt / info.totalCnt) * 100) || 0;
            const badgeLabel = label === 'ê³„ì†ê·¼ë¬´ì' ? 'primary' : 'success';
            
            return `
                <div style="padding: 8px;">
                    <div style="margin-bottom: 10px;">
                        <span class="badge badge-${badgeLabel}">${label}</span>
                        <span style="font-size: 0.85rem; font-weight: bold;">ì´ ${info.totalCnt}ëª…</span>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span>ëŒ€ê¸°</span>
                            <b class="wait-color">${info.waitCnt}</b>
                        </div>
                        <div class="stat-item">
                            <span>ì‚¬ìš©ì</span>
                            <b style="color: var(--primary)">${info.userConfirmCnt}</b>
                        </div>
                        <div class="stat-item">
                            <span>ê´€ë¦¬ì</span>
                            <b style="color: var(--success)">${info.adminConfirmCnt}</b>
                        </div>
                        <div class="stat-item">
                            <span>ì·¨ì†Œ</span>
                            <b style="color: var(--danger)">${info.cancelConfirmCnt}</b>
                        </div>
                    </div>
                    
                    <div style="margin: 8px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 0.7rem; color: #666;">ê´€ë¦¬ì ë§ˆê°ë¥ </span>
                            <span style="font-size: 0.8rem; font-weight: bold; color: ${color}">${rate}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${rate}%; background-color: ${color}"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee;">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span>ëª¨ë°”ì¼</span>
                                <b style="color: var(--purple); font-size: 0.8rem;">${info.scrapReqTypeMCnt || 0}</b>
                            </div>
                            <div class="stat-item">
                                <span>ì›¹</span>
                                <b style="color: var(--info); font-size: 0.8rem;">${info.scrapReqTypeWCnt || 0}</b>
                            </div>
                            <div class="stat-item">
                                <span>PDFê´€</span>
                                <b style="color: #6f42c1; font-size: 0.8rem;">${info.pdfupload1Cnt || 0}</b>
                            </div>
                            <div class="stat-item">
                                <span>PDFì‚¬</span>
                                <b style="color: var(--teal); font-size: 0.8rem;">${info.pdfupload2Cnt || 0}</b>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 6px;">
                            <span style="font-size: 0.65rem; color: #999;">í¸ë¦¬í•œ ì—°ë§ì •ì‚°: </span>
                            <b style="font-size: 0.75rem; color: var(--success)">${info.easyPdfCnt || 0}ëª…</b>
                        </div>
                    </div>
                </div>
            `;
        }

        function sortData(order) {
            document.querySelectorAll('.btn-sort').forEach(btn => btn.classList.remove('active'));
            if (window.event && window.event.currentTarget) {
                window.event.currentTarget.classList.add('active');
            }

            rawData.sort((a, b) => {
                let valA, valB;
                
                if (filterActive) {
                    // í•„í„° ON: ê³„ì†ê·¼ë¬´ì(stlTp: "1")ë§Œ ì§‘ê³„
                    valA = a.ìˆ˜ì§‘ì •ë³´_parsed
                        .filter(i => i.txformCd === 'YREND' && i.stlTp === "1")
                        .reduce((acc, curr) => acc + curr.totalCnt, 0);
                    valB = b.ìˆ˜ì§‘ì •ë³´_parsed
                        .filter(i => i.txformCd === 'YREND' && i.stlTp === "1")
                        .reduce((acc, curr) => acc + curr.totalCnt, 0);
                } else {
                    valA = a.totalSum || 0;
                    valB = b.totalSum || 0;
                }
                
                return order === 'desc' ? valB - valA : valA - valB;
            });
            
            renderDashboard(rawData);
        }

        function toggleFilter() {
            const toggle = document.getElementById('filterToggle');
            filterActive = toggle.checked;
            renderDashboard(rawData);
        }

        function showEasyPdfCompanyModal() {
            const modalBody = document.getElementById('modalBody');
            const modal = document.getElementById('easyPdfModal');
            
            // SaaSë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í¸ë¦¬í•œ ì—°ë§ì •ì‚° ì‚¬ìš© íšŒì‚¬ ì¶”ì¶œ
            const easyPdfCompanies = {};
            
            rawData.forEach(group => {
                const yrendData = group.ìˆ˜ì§‘ì •ë³´_parsed.filter(i => i.txformCd === 'YREND');
                const hasEasyPdf = yrendData.some(i => (i.easyPdfCnt || 0) > 0);
                
                if (hasEasyPdf) {
                    const saasName = group.ì„œë²„ëª…;
                    if (!easyPdfCompanies[saasName]) {
                        easyPdfCompanies[saasName] = [];
                    }
                    
                    const totalEasyPdf = yrendData.reduce((sum, i) => sum + (i.easyPdfCnt || 0), 0);
                    const totalCnt = yrendData.reduce((sum, i) => sum + i.totalCnt, 0);
                    
                    easyPdfCompanies[saasName].push({
                        id: group.ê·¸ë£¹ìˆœë²ˆ,
                        name: group.ì„œë²„ëª…,
                        date: group.ìˆ˜ì§‘ì¼,
                        easyPdfCnt: totalEasyPdf,
                        totalCnt: totalCnt,
                        rate: Math.round((totalEasyPdf / totalCnt) * 100)
                    });
                }
            });
            
            // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
            let html = '';
            const sortedSaas = Object.keys(easyPdfCompanies).sort();
            
            sortedSaas.forEach(saasName => {
                const companies = easyPdfCompanies[saasName];
                html += `
                    <div class="saas-section">
                        <div class="saas-header">
                            <span>${saasName}</span>
                            <span class="saas-count">${companies.length}ê°œ íšŒì‚¬</span>
                        </div>
                        <div class="company-list">
                `;
                
                companies.forEach(company => {
                    html += `
                        <div class="company-item">
                            <div class="company-name">${company.name}</div>
                            <div class="company-id">ê·¸ë£¹ìˆœë²ˆ: ${company.id}</div>
                            <div class="company-stats">
                                <span>ğŸ“… ${company.date}</span>
                                <span>ğŸ‘¥ ì‚¬ìš©ì: ${company.easyPdfCnt}ëª…</span>
                                <span>ğŸ“Š ì „ì²´: ${company.totalCnt}ëª…</span>
                                <span>âœ… ì‚¬ìš©ë¥ : ${company.rate}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div style="text-align: center; padding: 50px; color: #999;">í¸ë¦¬í•œ ì—°ë§ì •ì‚°ì„ ì‚¬ìš©í•˜ëŠ” íšŒì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function closeModal(event) {
            const modal = document.getElementById('easyPdfModal');
            modal.classList.remove('active');
        }
    </script>
</body>

</html>
